name: Push Images to ACR

on:
  push:
    branches:
      - main
      - onlypush
    paths:
      - 'deploy/docker-compose.yml'
      - '.github/workflows/ci.yml'

jobs:
  push-to-acr:
    runs-on: ubuntu-latest
    environment: secrets  # 指定 Aliyun 环境，对应存放密钥的环境
    env:
      SRC_REGISTRY_USERNAME: ${{ secrets.SRC_REGISTRY_USERNAME }}
      SRC_REGISTRY_PASSWORD: ${{ secrets.SRC_REGISTRY_PASSWORD }}
      JENKINS_WEBHOOK_URL: ${{ secrets.JENKINS_WEBHOOK_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Parse images from docker-compose.yml
        id: images
        run: |
          IMAGES=$(yq '.services[].image' deploy/docker-compose.yml | sort -u)
          echo "IMAGE_LIST<<EOF" >> $GITHUB_OUTPUT
          echo "$IMAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Images to process:"
          echo "$IMAGES"

      - name: Login to ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login -u "${{ secrets.ACR_USERNAME }}" --password-stdin "${{ secrets.ACR_REGISTRY_PUBLIC }}"

      - name: Pull, tag and push images to ACR
        env:
          ACR_REGISTRY_PUBLIC: ${{ secrets.ACR_REGISTRY_PUBLIC }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          IMAGE_LIST: ${{ steps.images.outputs.IMAGE_LIST }}
        run: |
          set -e
          echo "$IMAGE_LIST" | while read -r IMAGE; do
            if [ -z "$IMAGE" ]; then
              continue
            fi
            
            echo "Processing image: $IMAGE"
            
            # Pull source image
            echo "Pulling: $IMAGE"
            docker pull "$IMAGE"
            
            # Construct ACR image name (append ACR_REGISTRY/NAMESPACE prefix)
            # Format: registry.cn-hangzhou.aliyuncs.com/namespace/image-name:tag
            # Extract image name and tag
            IMAGE_NAME=$(echo "$IMAGE" | sed 's/:.*//') # Remove tag
            IMAGE_TAG=$(echo "$IMAGE" | sed 's/.*://') # Extract tag, default to latest
            if [ "$IMAGE_NAME" = "$IMAGE" ]; then
              IMAGE_TAG="latest"
            fi
            
            # Get base name (last part after last slash)
            BASE_NAME=$(echo "$IMAGE_NAME" | awk -F'/' '{print $NF}')
            
            ACR_IMAGE="$ACR_REGISTRY_PUBLIC/$ACR_NAMESPACE/$BASE_NAME:$IMAGE_TAG"
            
            echo "Tagging as: $ACR_IMAGE"
            docker tag "$IMAGE" "$ACR_IMAGE"
            
            # Push to ACR
            echo "Pushing to ACR: $ACR_IMAGE"
            docker push "$ACR_IMAGE"
            
            # Clean up local images
            docker rmi "$IMAGE" || true
            docker rmi "$ACR_IMAGE" || true
          done

      - name: Prepare images list for Jenkins webhook
        id: webhook_payload
        env:
          IMAGE_LIST: ${{ steps.images.outputs.IMAGE_LIST }}
        run: |
          # Convert image list to JSON format for webhook
          IMAGES_JSON=$(echo "$IMAGE_LIST" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "IMAGES_JSON=$IMAGES_JSON" >> $GITHUB_OUTPUT
          echo "Images JSON payload:"
          echo "$IMAGES_JSON"

      - name: Trigger Jenkins webhook (main branch only)
        if: github.ref == 'refs/heads/main' && env.JENKINS_WEBHOOK_URL != ''
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "action": "pull_acr",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "acr_registry": "${{ secrets.ACR_REGISTRY_PUBLIC }}",
              "acr_namespace": "${{ secrets.ACR_NAMESPACE }}",
              "images": ${{ steps.webhook_payload.outputs.IMAGES_JSON }}
            }' \
            "${{ env.JENKINS_WEBHOOK_URL }}" || echo "Webhook call failed, but images pushed successfully"

      - name: Summary
        run: |
          echo "✅ Workflow completed successfully"
          echo "Branch: ${{ github.ref_name }}"
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "Action: Pushed to ACR + Triggered Jenkins"
          else
            echo "Action: Pushed to ACR only"
          fi

